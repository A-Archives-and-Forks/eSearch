# 截屏

使用`node-screenshot`库，Wayland 平台调用了桌面的截屏软件，再读取图片，所以会有些慢。由于该库暂不支持 Linux Arm64，所以我在 nodejs 下模仿类似的操作，读取设置里的命令，调用外部截屏软件，然后读取图片。

## 广截屏

即滚动截屏

思路：获取滚动前后位移，拼接

由于我们很难通过系统 API 层面获取滚动的像素，比如一些网页可以监听滚动事件自己设置滚动距离，所以我们通过分析图片来获取滚动距离。

需要至少两张截屏图片，一张滚动前，一张滚动后。使用`uiohook-napi`获取鼠标滚动事件和方向键，也可以定时截屏。

可以通过特征点算法来分析图片位移，但`opencv.js`没有提供，所以我只使用了最简单的模板匹配算法。

由实践可知，模板需要小于源图片大小，否则匹配结果不准确，所以我们需要裁切第二张图片。

还要考虑的是一些界面有固定元素，比如导航栏等，我们可以通过异或算法来消除这些固定元素，但在 eSearch 中，我使用了简单的裁切，一般固定元素在图片四周，所以我们自己裁切，大部分情况下效果不错。

举个例子：有“目”字形的页面结构，第 1、3 个“口”可能是固定元素，第 2 可能是滚动元素。我们预期得到一个中间长，上下固定元素均保留的长截屏。我们裁切第 2 作为模板，匹配上一张截屏，得到位移。如果位移向下，把 2、3 覆盖到上一张截屏，这样 1 保留，2 延伸，并覆盖了上一张的 3。其他方向同理，如果考虑上下左右滚动的广截屏，以九宫格来切割。

![广截屏示意图](assets/long_clip.svg)
